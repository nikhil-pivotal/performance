# Mathematics of Portfolio Return

The rate of return is the gain or loss in market value of the portfolio relative to its starting value

```
r = (Ve - Vs)/Vs  or

r = (Ve/Vs) - 1

(1 + r) = Ve/Vs
```

`Ve/Vs` is termed as the wealth ratio that describes the change in wealth over the time period. It equals the rate of return plus 1.

If there are no external cash flows, the rate of return over the entire time periods is the compounded return over
multiple sub-periods

```
V1/Vs * V2/V1 * V3/V2 * ...... * Vn-1/Vn-2 * Ve/Vn-1 = Ve/Vs = (1 + r)  or

(1 + r1) * (1 + r2) * (1 + r3) * .... * (1 + rn) = (1 + r)
```

When there are external cash flows we need to adjust the methodology to make allowances for them since they do contribute
to the return.

## Money Weighted Rate of Return

The method of money weighted rate of return assumes that each dollar invested in the portfolio achieves the same
rate of return regardless of the time at which it was invested. `The weight of money invested in the portfolio at
any point in time will ultimately impact the final return`. Thus this methodology is biased towards the amount of
money invested: the return achieved when the amount of money invested is the largest will influence the final return 
the most. 

### IRR

```
Ve = Vs * (1 + r) + C1*(1 + r)^W1 + C2*(1 + r)^W2 + .... + CT*(1 + r)WT

Ct = the external cash flow on day t
Wt = weighting ratio to be applied on day t

Wt = (TD - Dt) / TD
Or WtY: When computing annualized IRR, you would use a weight for the length of time measured in years
WtY = Y - Yt  (Yt could be a fraction if investments were made during any year)

TD: Total number of days within the measurement period
Dt: Number of days since the beginning of the measurement period including holidays and weekends
```

### Simple Dietz

```
r = (Ve - Vs - C) / (Vs + C/2)

Assumes all of the external cash flow occurred midway through the performance measurement period
```

The Denominator is a measure of the average capital available for investment. 


### ICAA Method
Proposed by the Investment Council Association of America

```
r = (Ve - Vs - C + I) / (Vs + C/2)

I: Investment income generated by the portfolio
Assumes Investment income is available for re-investment

r = (Ve - Vs - C + I) / (Vs + (C - I)/2)

Assumes investment income is not available for re-investment and hence subtracted from the average capital.
```

### Modified Dietz

```
r = (Ve - Vs - C) / (Vs + Sum(Ci*Wi)

Ci: Cash flow at time i
Wi: Weight at time i

Wi = (TD - Di) / TD
Td: Total Days
Di: Number of days since the beginning of the period including holidays and weekends
    Di: Di+1 when start of day
```

If the cash flow occurred at the start of the day, it is reasonable to assume the portfolio manager has the entire
day use it to achieve the return in the time period. If it occurred at the end of the day, the portfolio manager
cannot use it for that day. So for start of day we add an additional day to the overall time period when calculating
the weight of the cash flow


## Time Weighted Rate of Return

Time alternative to money weighted return in that `each time period is given an equal weight regardless of the 
amount invested`.

In true time weighted return, a performance return is calculated for each sub-period between cash flows using 
simple wealth ratios. The returns for each of these sub-periods are then chain linked together to get the 
overall return

### Cash flow Timing dependence

If we assume an end of day cash flow, the formula to compute a time weighted return is as follows

```
(1 + r) = (V1 - C1)/Vs  * (V2 - C2)/V1 * ..... * (Vn-1 - Cn-1)/Vn-2 * Ve - Cn/Vn-1

(1 + r) = (1 + r1) * (1 + r2) * ..... (1 + rn-1) * (1 + rn)

Vi: Value of the portfolio just after a cash flow of Ci in the period i
Assumes an end of day Cash Flow occurrance
``` 

If we assume cash flows occur at the start of the day the equation for Time Weighted return changes to the 
following

```
(1 + r) = V1 / (Vs) * V2 / (V1 + C1) * ......  * Vn-1 / (Vn-2 + Cn-2) * Ve / (Vn-1 + Cn-1)  => No cash flow at the end

Vi: Market value of the portfolio at the start of the day just prior to receiving Cash flow Ci
Assumes a begin of day cash flow.
The Cash flow received at Time period i is used as the bmv to calculate the return for Time period i+1
```

For mid-day cash flow the equation changes to the following. This is a case of weighting the cash flow and is 
therefore no longer a true time weighted return

```
(1 + r) = V1 - Vs - C1 / (Vs + C1/2) * Vi - Vi-1 - Ci / (Vi-1 + Ci/2) * .... * Ve - Vn-1 - Cn / (Vn-1 - Cn/2)
```


### Unit Price (Unitized) Method

Is a variant of the Time Weighted return and calculated using a Unit Price or a NAV value of the portfolio.
`The Net Asset Value (NAV) or Unit Price is calculated immediately before each external cash flow by dividing the
market value by the number of units previously allocated`. The Cash flow is accounted for by then adding or 
subtracting (depending on the direction of the cash flow) a proportional number of units corresponding to the
time of the cash flow. The starting unit price value of the portfolio is usually assigned a notional value of
`1` or `100`.

```
(1 + r) = NAV1/NAVs * NAV2/NAV1 * ...... * NAVn-2/NAV/n-1 * NAVe/NAVn-1
```

An advantage of the unit price method is the ratio of the ending NAV value to the beginning NAV value provides
the same overall rate of return irrespective of the change in the portfolio value during the sub-periods due to
external cash flows

```
(1 + r) = NAVe/NAVs
        = NAV1/NAVs * NAV2/NAV1 * ...... * NAVn-2/NAV/n-1 * NAVe/NAVn-1
```

Upon an injection or withdrawl of cash flows, the number of units are increased or decreased based on the NAV
value at the time of the cash flow.

```
NAVi = Portfolio Market Value / Number of units allocated

# of new units on cash flow = Cash flow value / NAV
```

The Unit price can reconcile to the Time Weighted Return assuming the portfolio values and timing of cash flows
are properly aligned (proving it to be a Time Weighted Return variant).

### Analysis

Time Weighted Return is most appropriate when you want to evaluate the managers performance regardless of the
amount of money invested, whereas you'd use Money Weighted Returns when you want to report the performance of the
investment. 

A drawback or limitation of TWR is it's not always easy to get portfolio valuations on every external
cash flow. In these cases we use approximations to get to performance numbers that are close approximations to
a true Time Weighted Return

### Approxmiations to Time Weighted Returns

#### Index Substitutions

In the absence of the portfolio valuation at the time of the cash, one way to approximate it is to use the 
performance of a suitable index. So if the index return during a period is i % and the portfolio valuation known
at the start of the valuation period is M, you can approximate the market value of the portfolio at the time of 
the cash flow as follows

```
Portfolio Value at time of Cash flow = M * (1 + i/100)
```

#### Beta/Regression Method

The Index valuation method can be refined (and is regarded as slightly more accurate) by adjusting it for the 
portfolio's systematic risk as represented by the portfolio's beta to the index

```
From the snippet above
Portfolio Beta: B

Portfolio Valuation = M * (1 + (i/100)*B)
```

#### Money Weighted Return Ratio

One study had proven that the ratio of the Time Weighted Return of the Portfolio to the Benchmark (Notional 
Portfolio) is approximately equal to the ratio of the corresponding Money Weighted Return. Thus

```
(1 + MWRport)/(1 + MWRnotional) == (1 + TWRport) / (1 + TWRnotional)
```
Using this we can determine the TWRport given knowledge of the other three terms.


## Hybrid Methodologies

Two Hybrid methodologies that have been suggested, which essentially use a Money Weighted Return for each 
individual (single) period, and then chain links them together to form an overall cumulative Time Weighted Return

 * Linked Modified Dietz
 * Linked IRR
 
## Annualized Returns

The main purpose for calculating Annualized Returns is for the convenience of using a standard time period for
comparing returns over a long period time. i.e. It helps comparing say, two portfolios' performance over a time period of
ten years by saying portfolio A achieved an average annual return of 5% while the other was 6%. This can be
calculated using either the arithmetic or geometric methods.

```
Arithmetic: R = f/n * (Sigma(ri)

Geometric: R = ((Product(1 + ri)) ^ f/n) - 1

f: Number of time periods within a year (Frequency: Can be 12 for monthly or 4 for quarterly)
n: Number of time periods
```

Geometric Annualized returns are accurate since they take into account the compounding effect of the annualized
return over time. Which is why the Annualized Geometric return on compounding will ultimately equate to the 
cumulative return


If we assume a continuous compounding of returns, the final return will equate the value as shown below

```
1 + r = e^r` 
r`: Return obtained in the infinitesimally small period. Also called "Force of Return"

r` = ln(1 + r) 
```

An advantage of continuously compounded returns is that they are additive:

```
ln(1 + r) = ln(1 + r1) + ln(1 + r2) + ..... + ln(1 + rn)
```

## Gross of Fee and Net of Fee Calculations

Important to show the effect of fees charged to the investor have on the performance of the portfolio. 

Fees are normally deducted directly from the portfolio, in which case a rate of return computed on the portfolio
as is, would be a `Net-of-Fee` ror. If no such deduction is done on the portfolio for fees, the returns are
`Gross-of-Fee`, i.e. a return achieved without the effect of any fee charged.  Net of Fee returns can be 
`Grossed up` by representing the fee as a negative external cash flow. This in effect neutralizes any effect of
the fee deductions done on the portfolio thereby producing a gross of fee return from a net of fee one.

```
Portfolio BMV: 100
Fee: 0.1
EMV: 112

Net-of-Fee return = (112 - 100) / 100  
                  = 12%
                  
Gross-of-Fee return = (112 - (100 - 0.1)) / (100 - (0.1 / 2))
                    = 12.106%                                                        
```

Effectively we are reducing the initial portfolio value and average balance by the absolute amount of the fee
which ends up increasing the return.

It is possible to convert one type of fee based return from the other like so

```
Grossing NOF up: Rg = (1 + Rn) * (1 + f) - 1
Netting GOF down: Rn = ((1 + Rn) / (1 + f)) - 1

Rf: Gof Ror
Rn: Nof Ror
f: Fee rate, also called Total Expense Ratio (TER)
```

## Portfolio Component Returns

As we compute returns for the total portfolio, it's also necessary to calculate returns for the individual 
components (sectors, asset classes, countries etc.). Assuming the return calculation methodologies are consistent
the weighted sum of the return of the components should equal that of the total portfolio. `Note that the IRR 
methodology assumes a constant rate of return for all assets invested in the portfolio it can't be used for
component returns (it's not additive).`  Modified Dietz is typically used for component returns.

```
ri = (EMVi - (BMVi - CFi))/ (BMVi + Sum(CFi * WFi))

ri: Return of component i
EMVi: Ending Market Value for componet i
BMVi: Begin Market Value for compnent i
CFi: Cash flow for component i
WFi: Cash flow weighting for component i


r = Sum(wi * ri)

r: Total portfolio return
wi: Weight of component i in total portfolio

wi = BMVi + Sum(CFi * WFi) / BMV + Sum(CF * WF)

Sum(wi) = 1
```


### Shorts

The contribution of a short position should be computed by assigning a negative weight and multiplying it by the
negative return (assuming the price of the underlying asset fell). It is this combination of two negatives that
result in a positive return for short positions.

If the weight of the holding changes sign it is impossible to chain link (or compound) the performance of the
underlying holding (dont know why ?).

### Overlay strategies
Asset owners may allocate a part of the investment funds to be invested in derivatives or other instruments that
serve to hedge the risk of the other core investments. These may often be provided to a different overlay 
investment manager who may be provided little or no funds to be physically invested resulting in small, zero or 
negative asset values, which render traditional performance measurement methodologies useless.

Instead, the value of the assets that are `overlaid` (the value of the core assets) should be included in 
addition to the value of the overlaying assets themselves in the ror calculation of the overlaying assets. The 
numerator would only include the value of the overlaying assets.

### Multi-period component returns

The performance of the overall portfolio is driven by the allocations into each of the individual components
over time. It is therefore possible that the rate of return for the overall portfolio will be less or more than
that of the individual components due to the timing of allocation decisions over time.

eg. if a large allocation was made in Equities that had a poor performance return in that time period, the overall
portfolio return could be lower than that of the Equities component over the cumulative investment time period.

## Base and Local Currency Returns

The methods of calculation described above are applicable for investments in foreign securities as well as long
as they are converted to foreign currencies at the appropriate currency conversion rates.

Investments in foreign securities will include two components:
 * The core asset return in local currency: Achieved by a change in market value or flow of holdings in the local currency
 * The currency return: Caused by a change in the currency conversion rate over the investment time period
 
```
(1 + Rbase) = (1 + Rlocal) * (1 + Rcurrency)

Rcurrency: Currency return of currency c relative to the base currency
``` 

Although the local currency return of a portfolio consisting of assets in multiple currencies does not exist, it
is useful to make an intermediate calculation. The local return of a multi-currency portfolio is defined as the
weighted average local return of assets in each currency

```
Rlocal = Sum(Wi * Rlocali)

Rlocali: Local currency return for currency i
Wi: Weight of assets in currency i
```

The ratio of the base currency return with the local currency return of the portfolio calculated above will 
provided the implicit return due to currency in the portfolio.








 
 